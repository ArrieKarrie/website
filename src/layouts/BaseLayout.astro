---
import "../styles/global.css";
import { ClientRouter as ViewTransitions } from 'astro:transitions';

const { title, description = "Professional photography portfolio by Arman van Dijk Photography. Explore collections of automotive, event, wildlife, sport, portrait and concert photography." } = Astro.props;
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>{title}</title>
        <ViewTransitions />

        <script is:inline>
            // 1. Immediate Theme Check (Prevents Flash of White Mode)
            const getTheme = () => localStorage.getItem('mode');
            if (getTheme() === 'dark') {
                document.documentElement.classList.add('dark');
            }
        </script>

        <noscript>
            <style>body { opacity: 1 !important; }</style>
        </noscript>
    </head>
    
    <body>
        <slot/>
    </body>
</html>

<script>
    // 2. Helper to set theme
    function applyTheme() {
        if (localStorage.getItem('mode') === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    }

    // 3. Re-apply theme immediately after View Transition swap
    document.addEventListener('astro:after-swap', applyTheme);

    // 4. REVEAL LOGIC (Optimized & Fixed Types)
    function revealPage() {
        // Cast the selection to HTMLImageElement[] so TypeScript knows these are images
        const images = Array.from(document.querySelectorAll('img:not([loading="lazy"])')) as HTMLImageElement[];
        
        const promises = images.filter(img => !img.complete).map(img => {
            return new Promise((resolve) => {
                img.onload = () => resolve(true);
                img.onerror = () => resolve(true);
            });
        });

        // Wait for critical images OR a snappy 200ms timeout
        Promise.race([
            Promise.all(promises),
            new Promise(resolve => setTimeout(resolve, 200)) 
        ]).then(() => {
            document.body.classList.add('is-loaded');
        });
    }

    // 5. Resize Handler
    let resizeTimer: number | undefined;
    window.addEventListener("resize", () => {
        document.body.classList.add("resize-transition-stopper");
        clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(() => {
            document.body.classList.remove("resize-transition-stopper");
        }, 350);
    });

    // 6. Init Interactive Elements
    document.addEventListener('astro:page-load', () => {
        
        // A. Trigger the fade-in logic
        revealPage();

        // B. Ensure state matches
        applyTheme();

        // C. Light/Dark Toggle Logic
        const lightDarkModeToggle = document.getElementById('lightDarkModeButton');
        if (lightDarkModeToggle) {
            lightDarkModeToggle.addEventListener('click', () => {
                const element = document.documentElement;
                element.classList.toggle('dark');
                
                const newMode = element.classList.contains('dark') ? 'dark' : 'light';
                localStorage.setItem('mode', newMode);
            });
        }

        // D. Navigation/Hamburger Logic
        const navIcon = document.getElementById('hamburgerMenu');
        const navMenu = document.getElementById('nav');
        const blurOverlay = document.getElementById('blurredOverlay');

        if (navIcon) {
            navIcon.addEventListener('click', function() {
                navIcon.classList.toggle('open');
                navMenu?.classList.toggle('open');
                blurOverlay?.classList.toggle('open');
            });
        }
        
        if (blurOverlay) {
            blurOverlay.addEventListener('click', function() {
                navIcon?.classList.toggle('open');
                navMenu?.classList.toggle('open');
                blurOverlay.classList.toggle('open');
            });
        }
    });
</script>

<style is:global>
    /* Prevent white flash in dark mode */
    html {
        background-color: var(--color-background-light);
    }
    html.dark {
        background-color: var(--color-background-dark);
    }

    /* Start invisible */
    body {
        opacity: 0;
        transition: opacity 0.3s ease-in-out; 
    }

    /* Fade in */
    body.is-loaded {
        opacity: 1;
    }
</style>