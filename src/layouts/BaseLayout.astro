---
import "../styles/global.css";
import { ClientRouter as ViewTransitions } from 'astro:transitions';

const { title } = Astro.props;
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
        <ViewTransitions />

        <script is:inline>
            const getTheme = () => localStorage.getItem('mode');
            if (getTheme() === 'dark') {
                document.documentElement.classList.add('dark');
            }
        </script>
	</head>
	
	<body>
        <slot/>
	</body>
</html>

<script>
    // 2. Helper to set theme
    function applyTheme() {
        if (localStorage.getItem('mode') === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    }

    // 3. PERSISTENCE FIX: Re-apply theme immediately after View Transition swap
    document.addEventListener('astro:after-swap', applyTheme);

    // 4. Resize Handler
    let resizeTimer: number | undefined;
    window.addEventListener("resize", () => {
        document.body.classList.add("resize-transition-stopper");
        clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(() => {
            document.body.classList.remove("resize-transition-stopper");
        }, 350);
    });

    // 5. Init Interactive Elements (Runs on load & after navigation)
    document.addEventListener('astro:page-load', () => {
        
        // Ensure state matches (just in case)
        applyTheme();

        // Light/Dark Toggle Logic
        const lightDarkModeToggle = document.getElementById('lightDarkModeButton');
        if (lightDarkModeToggle) {
            lightDarkModeToggle.addEventListener('click', () => {
                const element = document.documentElement;
                element.classList.toggle('dark');
                
                const newMode = element.classList.contains('dark') ? 'dark' : 'light';
                localStorage.setItem('mode', newMode);
            });
        }

        // Navigation/Hamburger Logic
        const navIcon = document.getElementById('hamburgerMenu');
        const navMenu = document.getElementById('nav');
        const blurOverlay = document.getElementById('blurredOverlay');

        if (navIcon) {
            navIcon.addEventListener('click', function() {
                navIcon.classList.toggle('open');
                navMenu?.classList.toggle('open');
                blurOverlay?.classList.toggle('open');
            });
        }
        
        if (blurOverlay) {
            blurOverlay.addEventListener('click', function() {
                navIcon?.classList.toggle('open');
                navMenu?.classList.toggle('open');
                blurOverlay.classList.toggle('open');
            });
        }
    });
</script>