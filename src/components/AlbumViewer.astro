---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
    title: string;
    heroImage: ImageMetadata;
    featuredImages: ImageMetadata[];
}

const { title, heroImage, featuredImages } = Astro.props;
---

<div id="tip">
    <div id="tipContent">
        <span 
            id="viewAlbumBtn" 
            class="
                cursor-pointer 
                bg-linear-to-r 
                from-[var(--color-text-secondary-light)] 
                to-[var(--color-text-secondary-light)] 
                dark:from-[var(--color-text-secondary-dark)] 
                dark:to-[var(--color-text-secondary-dark)]
            "
        >
            View album
        </span>
        
        <span id="scrollIndicator" class="opacity-0 pointer-events-none">
            (Scroll)
        </span>
    </div>
</div>

<Image id="heroImage" src={heroImage} alt={title} class="h-full w-full object-cover transition-elements" />

{featuredImages && (
    <div 
        id="albumGallery" 
        class="
            flex flex-wrap 
            gap-1 
            h-full w-full 
            overflow-y-auto 
            hidden-initial 
            no-scrollbar
            content-start
        "
    >
        {featuredImages.map((img: ImageMetadata, index: number) => {
            const aspectRatio = img.width / img.height;
            return (
                <div 
                    id="albumImage"
                    class="relative h-[33%] grow cursor-pointer gallery-item"
                    style={`flex-grow: ${aspectRatio}; flex-basis: ${aspectRatio * 200}px;`}
                    data-index={index}
                >
                    <Image 
                        src={img} 
                        alt="" 
                        class="w-full h-full object-cover align-bottom pointer-events-none"
                    />
                </div>
            )
        })}
        <div class="grow-[999] basis-0"></div>
    </div>
)}

<script>
    document.addEventListener('astro:page-load', () => {
        const viewAlbumBtn = document.getElementById('viewAlbumBtn');
        const scrollIndicator = document.getElementById('scrollIndicator');
        const heroImage = document.getElementById('heroImage'); 
        const albumGallery = document.getElementById('albumGallery');

        let isGalleryView = false;
        let isAnimating = false;

        if (viewAlbumBtn && heroImage && albumGallery) {
            viewAlbumBtn.addEventListener('click', () => {
                if (isAnimating) return; 
                isAnimating = true;

                // Fade out Button Text
                viewAlbumBtn.classList.add('opacity-0');
                if(scrollIndicator) scrollIndicator.classList.add('opacity-0');

                if (!isGalleryView) {
                    // -> OPEN GALLERY
                    heroImage.classList.add('fade-out');

                    setTimeout(() => {
                        heroImage.classList.add('is-hidden'); 
                        albumGallery.classList.remove('hidden-initial');
                        void albumGallery.offsetWidth;
                        albumGallery.classList.add('fade-in');

                        // Update Text & Show Scroll Hint
                        viewAlbumBtn.innerText = "View cover";
                        viewAlbumBtn.classList.remove('opacity-0');
                        if(scrollIndicator) scrollIndicator.classList.remove('opacity-0');
                        
                        isGalleryView = true;
                        isAnimating = false;
                    }, 350);

                } else {
                    // -> CLOSE GALLERY
                    albumGallery.classList.remove('fade-in'); 
                    
                    setTimeout(() => {
                        albumGallery.classList.add('hidden-initial');
                        heroImage.classList.remove('is-hidden');
                        void heroImage.offsetWidth;
                        heroImage.classList.remove('fade-out'); 

                        viewAlbumBtn.innerText = "View album";
                        viewAlbumBtn.classList.remove('opacity-0');

                        isGalleryView = false;
                        isAnimating = false;
                    }, 350);
                }
            });
        }
    });
</script>

<style>
    /* --- TIP LAYOUT --- */
    #tip {
        grid-area: tip;
        position: relative;
        z-index: 20; 
    }

    #tipContent {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-end; 
        height: 100%;
        width: 50%;
        font-weight: 400;
        font-size: min(1svw, 2.02svh);
    }

    /* --- VIEW ALBUM BUTTON --- */
    #viewAlbumBtn {
        padding-bottom: 1px;
        text-decoration: none;
        background-position-y: 100%;
        background-repeat: no-repeat;
        transition: background-size 0.35s ease-in-out, opacity 350ms ease-in-out;
        background-size: 100% 1px; 
        background-position-x: 100%;
        display: inline-block;
        opacity: 1; 
    }
    #viewAlbumBtn.opacity-0 { opacity: 0; }
    #viewAlbumBtn:hover, #viewAlbumBtn:focus, #viewAlbumBtn:active {
        background-size: 0% 1px;
        background-position-x: 0%;
    }

    /* --- SCROLL INDICATOR --- */
    #scrollIndicator {
        opacity: 1;
        transition: opacity 350ms ease-in-out;
    }
    #scrollIndicator.opacity-0 { opacity: 0; }

    /* --- TRANSITIONS --- */
    .transition-elements {
        opacity: 1;
        visibility: visible;
        transition: opacity 350ms ease-in-out, visibility 350ms ease-in-out;
    }
    .transition-elements.fade-out { opacity: 0; }
    .transition-elements.is-hidden { visibility: hidden; display: none; }

    /* --- ALBUM GALLERY --- */
    #albumGallery {
        opacity: 0;
        transition: opacity 350ms ease-in-out;
        grid-area: heroImage;
        z-index: 5; 
    }
    .hidden-initial { visibility: hidden; display: none; }
    .fade-in { opacity: 1 !important; }

    /* --- MARGIN ADJUSTMENT (Desktop) --- */
    #heroImage, #albumGallery {
        margin-top: min(3.8svw, 7.68svh);
        height: calc(100% - min(3.8svw, 7.68svh));
        position: relative; 
        z-index: 1;
    }

    /* --- UTILITIES --- */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    @media (max-aspect-ratio: 3.1/4) {
        #tipContent { width: 100%; font-size: 2.2svw; }
        #viewAlbumBtn { font-size: 2.2svw; }
        
        #albumGallery { grid-area: heroImage; }

        #heroImage, #albumGallery {
            margin-top: 3.8svw;
            padding-bottom: 2.2svw;
            height: 100%;
        }

        #albumImage { height: 45%; }
    }
</style>