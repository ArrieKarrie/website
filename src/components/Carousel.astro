---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';

// 1. Fetch the projects collection
const projects = await getCollection('projects');

// 2. Accept ID and Class props
const { id, class: className } = Astro.props;

// 3. Calculate dynamic variables for the CSS animation
const projectCount = projects.length;
// Optimization: Pre-calculate the duration string
const duration = `${projectCount * 5}s`;
---

<div id={id} class={className}>
    <div 
        class="carouselWrapper" 
        style={{
            '--item-count': projectCount, 
            '--duration': duration
        }}
    >
        {projects.map((project, index) => (
            <a 
                href={`/projects/${project.slug}`} 
                class="carouselItem block" 
                style={{ '--i': index + 1 }}
            >
                <Image 
                    class="image" 
                    src={project.data.heroImage} 
                    alt={project.data.title}
                    widths={[600, 900, 1200]}
                    sizes="(max-width: 768px) 50vh, 66vh"
                    loading="eager"
                    style={`object-position: ${project.data.heroPosition || 'center'};`}
                />
                <div class="imageText">{project.data.title}</div>
            </a>
        ))}
    </div>
</div>

<style>
    /* Define complex calculations once in local variables 
       to avoid repetition and improve readability.
    */
    :root {
        /* Default (Desktop) Math */
        --c-height-desktop: max(calc(0.52 * (100svh - 2 * 7.68svh) - 2 * 7.68svh), calc(0.52 * (100svh - 7.6svw) - 7.6svw));
        --c-width-desktop: calc(4 / 3 * var(--c-height-desktop));
        
        /* Mobile Math */
        --c-height-mobile: max(calc(0.4 * (100svh - 2 * 7.68svh) - 2 * 7.68svh), calc(0.4 * (100svh - 7.6svw) - 7.6svw));
        --c-width-mobile: calc(3 / 4 * var(--c-height-mobile));
    }

    .carouselWrapper {
        /* Assign local vars based on specific component needs */
        --item-height: var(--c-height-desktop);
        --item-width: var(--c-width-desktop);

        width: calc(100svw - 2 * min(3.8svw, 7.68svh));
        margin-inline: auto;
        position: relative;
        height: var(--item-height);
        overflow: hidden;
        
        /* Optimization: Gradient mask for smooth edges */
        mask-image: linear-gradient(
            to right,
            rgba(0, 0, 0, 0),
            rgba(0, 0, 0, 1) 10%,
            rgba(0, 0, 0, 1) 90%,
            rgba(0, 0, 0, 0)
        );
        -webkit-mask-image: linear-gradient(
            to right,
            rgba(0, 0, 0, 0),
            rgba(0, 0, 0, 1) 10%,
            rgba(0, 0, 0, 1) 90%,
            rgba(0, 0, 0, 0)
        );
    }

    .carouselWrapper:hover .carouselItem {
        animation-play-state: paused;
    } 

    @keyframes scrollLeft {
        to { left: calc(-1 * var(--item-width)); }
    }

    .carouselItem {
        width: var(--item-width);
        height: 100%;
        position: absolute;
        
        /* Initial Position: Far right off-screen */
        left: max(calc(var(--item-width) * var(--item-count)), 100%);
        
        cursor: pointer;
        
        /* Animation Logic */
        animation: scrollLeft var(--duration) linear infinite;
        animation-delay: calc(var(--duration) / var(--item-count) * (var(--item-count) - var(--i)) * -1);

        /* PERFORMANCE: Hint browser to promote this to a layer */
        will-change: left; 
    }

    .carouselItem .image {
        height: 100%;
        width: 100%;
        object-fit: cover;
        transition: filter ease-in-out 350ms;
        display: block;
    }

    .carouselItem:hover .image {
        filter: blur(5px);
    }

    .carouselItem .imageText {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        white-space: nowrap; /* Standard property preferred over text-wrap */
        z-index: 1;
        font-size: min(1.6svw, 3.224svh);
        font-weight: 400;
        color: var(--color-background-light); 
        opacity: 0;
        transition: opacity 350ms ease-in-out;
        pointer-events: none; 
    }

    .carouselItem:hover .imageText {
        opacity: 1;
    }

    @media (max-aspect-ratio: 3.1/4) {
        .carouselWrapper {
            /* Switch to Mobile sizing variables */
            --item-height: var(--c-height-mobile);
            --item-width: var(--c-width-mobile);
        }

        .carouselItem .imageText {
            font-size: min(3.52svw, 7.0928svh);
        }
    }
</style>